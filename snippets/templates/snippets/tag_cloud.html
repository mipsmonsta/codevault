{% extends 'base.html' %}

{% block title %}Tags Cloud - CodeVault{% endblock %}

{% block extra_css %}
<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/d3-cloud/build/d3.layout.cloud.js"></script>
{% endblock %}

{% block content %}
{% if data %}
<div id="wordCloud" class="col-md-6 mx-auto"></div>
{{ data|json_script:"data" }}

<script>
    const data = JSON.parse(document.getElementById('data').textContent);
    
    // For responsive width (offsetWidth includes padding, content, scrollbar and 
    // borders)
    const width = document.getElementById("wordCloud").offsetWidth; 
    const height = 400;

    const layout = d3.layout.cloud()
    .size([width, height])
    .words(data.map(tag => ({text:tag.name, 
        count: tag.count,
        size: 10 + tag.count * 5, 
        id:tag.id})))
    .padding(5)
    .rotate(() => 0)
    .font("Impact")
    .fontSize(d => d.size)
    .on("end", draw);

    layout.start();

    function draw(words) {
        const svg = d3.select("#wordCloud").append("svg")
        .attr("width", layout.size()[0])
        .attr("height", layout.size()[1])
        .append("g")
        .attr("transform", "translate(" + layout.size()[0] / 2 + "," + layout.size()[1] / 2 + ")");

        const links = svg.selectAll("a")
        .data(words)
        .enter()
        .append("a")
        .attr("xlink:href", d => `/tags/${encodeURIComponent(d.id)}/`) // ✅ dynamic URL
        .style("cursor", "pointer");

        links.append("text")
        .style("font-size", d => d.size + "px")
        .style("font-family", "Impact")
        .style("fill", (d, i) => d3.schemeCategory10[i % 10])
        .attr("text-anchor", "middle")
        .attr("transform", d => "translate(" + [d.x, d.y] + ")rotate(" + d.rotate + ")")
        .text(d => d.text)
        .append("title") // ✅ tooltip inside text element
        .text(d => `${d.text} (snippets: ${d.count})`);
    }
</script>
        
        
{% else %}
<div class="text-center py-5">
    <i class="fas fa-tags fa-3x text-muted mb-3"></i>
    <h4 class="text-muted">No tags found</h4>
    <p class="text-muted">Tags will appear here once snippets are created with tags.</p>
</div>
{% endif %}
        
{% endblock %} 